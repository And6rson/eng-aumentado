<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Hemogramas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f8f9fa; 
            color: #333;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px; 
            border-radius: 15px; 
            margin-bottom: 25px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .header h1 { 
            font-size: 2.5em; 
            margin-bottom: 10px; 
        }
        .header p { 
            font-size: 1.2em; 
            opacity: 0.9; 
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 20px; 
            margin-bottom: 25px; 
        }
        .stat-card { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            text-align: center;
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-value { 
            font-size: 2.2em; 
            font-weight: bold; 
            color: #2c3e50; 
            margin-bottom: 5px;
        }
        .stat-label { 
            color: #7f8c8d; 
            font-size: 0.9em;
            font-weight: 500;
        }
        .charts-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 25px; 
            margin-bottom: 25px; 
        }
        .chart-container { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        .chart-container h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .full-width { 
            grid-column: 1 / -1; 
        }
        #map { 
            height: 500px; 
            border-radius: 10px;
            margin-top: 10px;
        }
        .filters { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
            display: flex; 
            gap: 20px; 
            align-items: end; 
            flex-wrap: wrap;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        .filter-group { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            flex: 1;
            min-width: 150px;
        }
        .filter-group label { 
            font-weight: 600; 
            color: #2c3e50; 
            font-size: 0.9em; 
        }
        .filter-group input, .filter-group select { 
            padding: 10px 12px; 
            border: 2px solid #e9ecef; 
            border-radius: 6px; 
            font-size: 0.95em;
            transition: border-color 0.2s ease;
        }
        .filter-group input:focus, .filter-group select:focus {
            border-color: #667eea;
            outline: none;
        }
        button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            padding: 12px 25px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600;
            transition: all 0.2s ease;
        }
        button:hover { 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .secondary-btn {
            background: #6c757d;
        }
        .secondary-btn:hover {
            background: #5a6268;
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }
        .alert-badge { 
            display: inline-block; 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 0.8em; 
            font-weight: bold; 
            color: white; 
        }
        .severity-4 { background: #e74c3c; }
        .severity-3 { background: #e67e22; }
        .severity-2 { background: #f1c40f; color: #333; }
        .severity-1 { background: #27ae60; }
        .upload-section { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 25px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        .upload-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        #fileInput {
            margin-bottom: 15px;
            padding: 10px;
            border: 2px dashed #dee2e6;
            border-radius: 6px;
            width: 100%;
        }
        #uploadStatus {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-weight: 500;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th {
            background: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }
        tr:hover {
            background: #f8f9fa;
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Sistema de Monitoramento de Hemogramas</h1>
            <p>Dashboard em tempo real para an√°lise de exames hematol√≥gicos - Estado de Goi√°s</p>
        </div>

        <!-- Filtros -->
        <div class="filters">
            <div class="filter-group">
                <label>üë§ Idade M√≠nima</label>
                <input type="number" id="ageMin" placeholder="0" min="0" max="120">
            </div>
            <div class="filter-group">
                <label>üë§ Idade M√°xima</label>
                <input type="number" id="ageMax" placeholder="120" min="0" max="120">
            </div>
            <div class="filter-group">
                <label>üèôÔ∏è Munic√≠pio</label>
                <input type="text" id="municipalityCode" placeholder="C√≥digo do munic√≠pio">
            </div>
            <div class="filter-group">
                <label>üìÖ Per√≠odo (dias)</label>
                <select id="daysBack">
                    <option value="7">7 dias</option>
                    <option value="30" selected>30 dias</option>
                    <option value="90">90 dias</option>
                    <option value="365">1 ano</option>
                </select>
            </div>
            <button onclick="loadData()">üîç Aplicar Filtros</button>
            <button onclick="resetFilters()" class="secondary-btn">üîÑ Limpar</button>
        </div>

        <!-- Upload -->
        <div class="upload-section">
            <h3>üì§ Upload de Arquivos CSV</h3>
            <input type="file" id="fileInput" accept=".csv">
            <button onclick="uploadFile()">üìé Enviar Arquivo</button>
            <div id="uploadStatus"></div>
        </div>

        <!-- Estat√≠sticas -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalExams">0</div>
                <div class="stat-label">Total de Exames</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgHemoglobin">0</div>
                <div class="stat-label">Hemoglobina M√©dia (g/dL)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgPlatelets">0</div>
                <div class="stat-label">Plaquetas M√©dias</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeAlerts">0</div>
                <div class="stat-label">Alertas Ativos</div>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3>üìä Distribui√ß√£o de Alertas por Gravidade</h3>
                <canvas id="alertsChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>üìà Taxas de Anomalias Hematol√≥gicas</h3>
                <canvas id="anomaliesChart"></canvas>
            </div>
            <div class="chart-container full-width">
                <h3>üó∫Ô∏è Heatmap Municipal - Taxa de Anemia</h3>
                <div id="map"></div>
                <div style="margin-top: 15px; font-size: 0.9em; color: #6c757d;">
                    üí° Clique nos c√≠rculos para ver detalhes por munic√≠pio
                </div>
            </div>
        </div>

        <!-- Tabela de Alertas -->
        <div class="chart-container full-width">
            <h3>‚ö†Ô∏è Alertas Recentes</h3>
            <div id="alertsTable">
                <p>Carregando alertas...</p>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let alertsChart, anomaliesChart, map;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            initMap();
        });

        // Carregar dados
        async function loadData() {
            showLoading('statsGrid', 'Carregando estat√≠sticas...');
            showLoading('alertsTable', 'Carregando alertas...');
            
            const filters = getFilters();
            
            try {
                // Carregar m√©tricas
                const metricsResponse = await fetch(`/metrics?${new URLSearchParams(filters)}`);
                const metrics = await metricsResponse.json();
                
                // Carregar alertas
                const alertsResponse = await fetch(`/alerts?days_back=${filters.days_back}`);
                const alertsData = await alertsResponse.json();
                
                // Carregar heatmap
                const heatmapResponse = await fetch(`/heatmap?days_back=${filters.days_back}`);
                const heatmapData = await heatmapResponse.json();
                
                updateDashboard(metrics, alertsData, heatmapData);
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showError('statsGrid', 'Erro ao carregar dados');
                showError('alertsTable', 'Erro ao carregar alertas');
            }
        }

        // Atualizar dashboard
        function updateDashboard(metrics, alertsData, heatmapData) {
            updateStatsGrid(metrics);
            updateCharts(metrics);
            updateMap(heatmapData.heatmap_data);
            updateAlertsTable(alertsData.alerts || []);
        }

        // Atualizar estat√≠sticas
        function updateStatsGrid(metrics) {
            document.getElementById('totalExams').textContent = metrics.total_exams?.toLocaleString('pt-BR') || '0';
            document.getElementById('avgHemoglobin').textContent = (metrics.avg_hemoglobin || 0).toFixed(1);
            document.getElementById('avgPlatelets').textContent = (metrics.avg_platelets || 0).toLocaleString('pt-BR');
            document.getElementById('activeAlerts').textContent = (metrics.active_alerts || alertsData?.alerts?.length || 0).toLocaleString('pt-BR');
        }

        // Upload de arquivo
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const statusDiv = document.getElementById('uploadStatus');
            
            if (!fileInput.files[0]) {
                statusDiv.innerHTML = '<span class="error">‚ö†Ô∏è Selecione um arquivo</span>';
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                statusDiv.innerHTML = '<span class="loading">üì§ Enviando arquivo...</span>';
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (response.ok) {
                    statusDiv.innerHTML = `<span class="success">‚úÖ ${result.message} (${result.alerts_generated || 0} alertas gerados)</span>`;
                    fileInput.value = ''; // Limpar input
                    loadData(); // Recarregar dados
                } else {
                    statusDiv.innerHTML = `<span class="error">‚ùå Erro: ${result.error}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="error">‚ùå Erro de conex√£o</span>';
                console.error('Upload error:', error);
            }
        }

        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([-16.3291, -48.9530], 7); // Centro de Goi√°s
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Atualizar mapa com heatmap
        function updateMap(heatmapData) {
            // Limpar marcadores existentes
            map.eachLayer((layer) => {
                if (layer instanceof L.Circle) {
                    map.removeLayer(layer);
                }
            });

            if (!heatmapData || heatmapData.length === 0) {
                // Adicionar marcador padr√£o se n√£o houver dados
                L.marker([-16.3291, -48.9530])
                    .addTo(map)
                    .bindPopup('Goi√°s - Aguardando dados do heatmap')
                    .openPopup();
                return;
            }

            heatmapData.forEach(item => {
                // Gerar coordenadas aleat√≥rias dentro de Goi√°s para demonstra√ß√£o
                const lat = -16.3 + (Math.random() * 2 - 1);
                const lng = -49 + (Math.random() * 2 - 1);
                
                // Cor baseada na taxa de anemia
                let color, severity;
                if (item.anemia_rate > 10) {
                    color = '#e74c3c'; severity = 'Alta';
                } else if (item.anemia_rate > 5) {
                    color = '#e67e22'; severity = 'M√©dia';
                } else {
                    color = '#27ae60'; severity = 'Baixa';
                }
                
                // Tamanho baseado no n√∫mero de exames
                const radius = Math.max(item.exam_count * 50, 10000);
                
                L.circle([lat, lng], {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.6,
                    radius: radius
                }).addTo(map).bindPopup(`
                    <div style="min-width: 200px;">
                        <h4 style="margin: 0 0 10px 0; color: #2c3e50;">Munic√≠pio: ${item.municipality_code}</h4>
                        <p><strong>Exames:</strong> ${item.exam_count.toLocaleString('pt-BR')}</p>
                        <p><strong>Taxa de Anemia:</strong> <span style="color: ${color}; font-weight: bold;">${item.anemia_rate}%</span> (${severity})</p>
                        <p><strong>Trombocitopenia:</strong> ${item.thrombocytopenia_rate}%</p>
                        <p><strong>Leucopenia:</strong> ${item.leukopenia_rate || 'N/A'}%</p>
                    </div>
                `);
            });
        }

        // Atualizar gr√°ficos
        function updateCharts(metrics) {
            updateAlertsChart();
            updateAnomaliesChart(metrics);
        }

        function updateAlertsChart() {
            const ctx = document.getElementById('alertsChart').getContext('2d');
            
            if (alertsChart) alertsChart.destroy();
            
            // Dados simulados para demonstra√ß√£o
            const severityData = [12, 8, 5, 2]; // Baixa, M√©dia, Alta, Cr√≠tica
            
            alertsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Baixa', 'M√©dia', 'Alta', 'Cr√≠tica'],
                    datasets: [{
                        data: severityData,
                        backgroundColor: ['#27ae60', '#f1c40f', '#e67e22', '#e74c3c'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw} alertas`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        function updateAnomaliesChart(metrics) {
            const ctx = document.getElementById('anomaliesChart').getContext('2d');
            
            if (anomaliesChart) anomaliesChart.destroy();
            
            anomaliesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Anemia Grave', 'Anemia Moderada', 'Trombocitopenia Grave', 'Trombocitopenia Moderada', 'Leucopenia'],
                    datasets: [{
                        label: 'Taxa (%)',
                        data: [
                            metrics.anemia_severe_percent || 2.5,
                            metrics.anemia_moderate_percent || 8.7,
                            metrics.thrombocytopenia_severe_percent || 1.2,
                            metrics.thrombocytopenia_moderate_percent || 4.3,
                            metrics.leukopenia_percent || 3.1
                        ],
                        backgroundColor: [
                            '#e74c3c', '#e67e22', '#e74c3c', '#e67e22', '#3498db'
                        ],
                        borderColor: [
                            '#c0392b', '#d35400', '#c0392b', '#d35400', '#2980b9'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 15,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Atualizar tabela de alertas
        function updateAlertsTable(alerts) {
            const tableContainer = document.getElementById('alertsTable');
            
            if (alerts.length === 0) {
                tableContainer.innerHTML = '<p>‚úÖ Nenhum alerta ativo encontrado</p>';
                return;
            }
            
            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Gravidade</th>
                            <th>Condi√ß√£o</th>
                            <th>Munic√≠pio</th>
                            <th>Idade</th>
                            <th>Valores</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${alerts.slice(0, 10).map(alert => `
                            <tr>
                                <td>
                                    <span class="alert-badge severity-${alert.severity}">
                                        ${alert.severity === 4 ? 'Cr√≠tico' : alert.severity === 3 ? 'Alto' : alert.severity === 2 ? 'M√©dio' : 'Baixo'}
                                    </span>
                                </td>
                                <td>${alert.condition || 'N/A'}</td>
                                <td>${alert.municipality_code || 'N/A'}</td>
                                <td>${alert.patient_age || 'N/A'}</td>
                                <td>
                                    ${alert.hemoglobin ? `Hb: ${alert.hemoglobin} ` : ''}
                                    ${alert.platelets ? `Plt: ${alert.platelets.toLocaleString('pt-BR')} ` : ''}
                                    ${alert.leukocytes ? `WBC: ${alert.leukocytes}` : ''}
                                </td>
                                <td>${alert.alert_at ? new Date(alert.alert_at).toLocaleDateString('pt-BR') : 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${alerts.length > 10 ? `<p style="margin-top: 15px; color: #6c757d;">... e mais ${alerts.length - 10} alertas</p>` : ''}
            `;
            
            tableContainer.innerHTML = tableHTML;
        }

        // Fun√ß√µes auxiliares
        function getFilters() {
            return {
                age_min: document.getElementById('ageMin').value || null,
                age_max: document.getElementById('ageMax').value || null,
                municipality_code: document.getElementById('municipalityCode').value || null,
                days_back: document.getElementById('daysBack').value
            };
        }

        function resetFilters() {
            document.getElementById('ageMin').value = '';
            document.getElementById('ageMax').value = '';
            document.getElementById('municipalityCode').value = '';
            document.getElementById('daysBack').value = '30';
            loadData();
        }

        function showLoading(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<p style="color: #6c757d;">‚è≥ ${message}</p>`;
            }
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<p style="color: #e74c3c;">‚ùå ${message}</p>`;
            }
        }
    </script>
</body>
</html>
